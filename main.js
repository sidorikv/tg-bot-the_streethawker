require('dotenv').config();
const TelegramBot = require('node-telegram-bot-api');
const converter = require('current-currency');

const bot = new TelegramBot(process.env.API_KEY, {
    polling: true
})

const commands = [
    {
        command: 'info',
        description: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞'
    }
]

bot.setMyCommands(commands)

bot.on('text', async (message) => {

    if (message.text === '/start' || message.text === '/info') {
        await bot.sendPhoto(message.chat.id, 'src/img/startedLogo.jpg', {
            caption: '*–ü—Ä–∏–≤–µ—Ç!* –≠—Ç–æ –±–æ—Ç StreetHawker\n–Ø –ø–æ–º–æ–≥—É –±—ã—Å—Ç—Ä–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É –∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ —Å —Å–∞–π—Ç–∞ *POIZON*',
            parse_mode: 'Markdown',
            reply_markup: {
                inline_keyboard: [
                    [{text: '–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ü–µ–Ω üßÆ', callback_data: 'price_calculator'}],
                    [{text: '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ üí¥', callback_data: 'checkout'}],
                    [{text: '–ü—Ä–æ —Å–∫–∞–º üí©', callback_data: 'about_scam'}, {text: '–ü—Ä–æ –∫—É—Ä—Å üá®üá≥', callback_data: 'about_course'}],
                    [{text: '–û—Ç–∑—ã–≤—ã üì¢', callback_data: 'feedback'}]
                ]
            }
        })
    }

})

bot.on('callback_query', async (callback) => {
    switch(callback.data) {
        case 'about_course':
            const current_currency = (((await converter.convert('CNY', 1, 'RUB')).amount + 1).toFixed(2))
            await bot.sendMessage(
                callback.message.chat.id,
                `*–ü—Ä–æ –∫—É—Ä—Å*:\n–ö—É—Ä—Å —é–∞–Ω—è –∫ —Ä—É–±–ª—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: ${current_currency}\n\n–ü–æ—á–µ–º—É —É –º–µ–Ω—è  —Ç–∞–∫–æ–π –±–æ–ª—å—à–æ–π –∫—É—Ä—Å —é–∞–Ω—è?üá®üá≥\n–ï—Å–ª–∏ –≤—ã –∑–∞–¥–∞–ª–∏—Å—å —Ç–∞–∫–∏–º –≤–æ–ø—Ä–æ—Å–æ–º, –∑–Ω–∞—á–∏—Ç –≤—ã –∑–∞—à–ª–∏ –Ω–∞ —Å–∞–π—Ç [–¶–µ–Ω—Ç—Ä–æ–±–∞–Ω–∫–∞ –†–§](http://cbr.ru/) –∏ —Å–ø—Ä–∞–≤–∞ —Å–Ω–∏–∑—É –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –∏ —É–≤–∏–¥–µ–ª–∏, —á—Ç–æ –æ–Ω –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –º–æ–µ–≥–æ  –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 2 —Ä—É–±–ª—è (—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –Ω–µ –ø—Ä–∏–≤–æ–∂—É —Ç–æ—á–Ω—ã—Ö —Ü–∏—Ñ—Ä, —Ç.–∫. —Å–∏—Ç—É–∞—Ü–∏—è –º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å)\n\n–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ –≤—ã—Å–æ–∫–æ–º –∫—É—Ä—Å–µ:\n‚ùóÔ∏è–í —Ç–µ–∫—É—â–∏—Ö —Ä–µ–∞–ª–∏—è—Ö –Ω–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å –≤–∞–ª—é—Ç—É –¥–∞–∂–µ –±–ª–∏–∑–∫–æ –∫ –∫—É—Ä—Å—É –¶–ë\n–ù–∞–ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ –∫–∞–∫–æ–π —Ü–µ–Ω–µ *–ü–†–û–î–ê–ï–¢* [–°–±–µ—Ä–±–∞–Ω–∫](http://www.sberbank.ru/ru/quotes/currencies?currency=CNY) —é–∞–Ω—å –û–±—ã—á–Ω–æ —ç—Ç–æ –ø–ª—é—Å 3,5 —Ä—É–±–ª—è –∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º—É –∫—É—Ä—Å—É –¶–ë\n\n–Ø —Å–æ–≤–µ—Ä—à–∞—é –æ–ø–µ—Ä–∞—Ü–∏–∏  —Å –≤–∞–ª—é—Ç–æ–π "–¥–µ–Ω—å –≤ –¥–µ–Ω—å" - –≤—ã –ø–µ—Ä–µ–≤–µ–ª–∏ –º–Ω–µ —Ä—É–±–ª–∏, —è —Å—Ä–∞–∑—É –æ–ø–ª–∞—Ç–∏–ª–∏ –∑–∞–∫–∞–∑ –≤ —é–∞–Ω—è—Ö "–∏–∑ —Å–≤–æ–∏—Ö", —Å—Ä–∞–∑—É –∂–µ –ø–æ–º–µ–Ω—è–ª –≤–∞—à–∏ —Ä—É–±–ª–∏ –Ω–∞ —é–∞–Ω—å. –Ø –Ω–µ –∑–∞–Ω–∏–º–∞—é—Å—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ–º —Ä—É–±–ª–µ–π –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –ø–∞–¥–µ–Ω–∏—è –∫—É—Ä—Å–∞, —á—Ç–æ–±—ã –Ω–∞ —ç—Ç–æ–º –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å - —ç—Ç–æ –Ω–µ –º–æ–π –±–∏–∑–Ω–µ—Å. (—Ç–µ–º–±–æ–ª–µ–µ, —á–∞—â–µ –≤—Å–µ–≥–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±—Ä–∞—Ç–Ω–æ–µ)\n\n–Ø —Å—Ç–∞—Ä–∞—é—Å—å  –∑–∞–∫—É–ø–∞—Ç—å –≤–∞–ª—é—Ç—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—à–µ–≤–æ –∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ.\n–°–≤–µ—Ä—å—Ç–µ –º–æ–π –∫—É—Ä—Å —Å –∫—É—Ä—Å–æ–º —É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ –≤—ã –ø–æ–π–º–µ—Ç–µ, —á—Ç–æ —è –º–æ–ª–æ–¥–µ—Ü , –¥–∞–∂–µ –±–µ–∑ —É—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–π\n\n–ö–∞–∫–æ–π –±—É–¥–µ—Ç –∫—É—Ä—Å –∑–∞–≤—Ç—Ä–∞?üí¥üá®üá≥üí¥\n–ú—ã –Ω–µ –∑–Ω–∞–µ–º —Ç–∞–∫–∂–µ –∫–∞–∫ –∏ –Ω–µ –∑–Ω–∞–µ—Ç–µ –≤—ã. –í—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º(—Ö–æ—Ç—å –Ω–∞ 100 —é–∞–Ω–µ–π, —Ö–æ—Ç—å –Ω–∞ 100 000 —é–∞–Ω–µ–π) –º—ã —Å–æ–≤–µ—Ç—É–µ–º –Ω–µ –∂–¥–∞—Ç—å –∑–∞–≤—Ç—Ä–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ –∑–∞–≤—Ç—Ä–∞ –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ —Ö—É–∂–µ. –í —Ç–∞–∫–æ–º –º–∏—Ä–µ –∂–∏–≤–µ–º.`,
                {
                    parse_mode: 'Markdown',
                    disable_web_page_preview: true
                }
            )
            break
        
        case 'about_scam':
            await bot.sendMessage(
                callback.message.chat.id,
                '*–ü—Ä–æ —Å–∫–∞–º*:\n–ò—Ç–∞–∫, –≤—ã –∑–∞–¥–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å–æ–º —Å–∫–∞–º –ª–∏ *The Street Hawker* –∏–ª–∏ –Ω–µ —Å–∫–∞–º. –ú–æ–∂–Ω–æ –ª–∏ —É –º–µ–Ω—è –∑–∞–∫–∞–∑—ã–≤–∞—Ç—å? –†–∞—Å—Å–∫–∞–∂—É –Ω–µ–º–Ω–æ–≥–æ, –ø–æ—á–µ–º—É —è –Ω–µ —Å–∫–∞–º, –∞ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∫–æ–Ω–µ—á–Ω–æ –∂–µ –í–∞–º. –í –∫–∞—Ä–º–∞–Ω –∑–∞ –≤–∞—à–∏–º–∏ –¥–µ–Ω—å–≥–∞–º–∏ —è –Ω–µ –ª–µ–∑—É. –Ø –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞—Ä–∞—é—Å—å –æ–∫–∞–∑—ã–≤–∞—Ç—å —Ö–æ—Ä–æ—à–∏–π —Å–µ—Ä–≤–∏—Å\n\n1. –£ –º–µ–Ω—è –µ—Å—Ç—å *–°–í–û–ô* —Å–∫–ª–∞–¥ –≤ –ö–∏—Ç–∞–µ, –∑–∞ –Ω–µ–≥–æ –æ—Ç–≤–µ—á–∞–µ—Ç –º–æ–π –ø–∞—Ä—Ç–Ω–µ—Ä –º–∏—Å—Ç–µ—Ä –≠–Ω—å—è–æ. –Ø –ø–ª–∞—á—É –∑–∞ —ç—Ç–æ—Ç —Å–∫–ª–∞–¥ –µ–∂–µ–º–µ—Å—è—á–Ω–æ. –≠—Ç–æ —Å–∫–ª–∞–¥ –Ω–µ –∑–Ω–∞–∫–æ–º—ã—Ö, –Ω–µ –¥—Ä—É–∑–µ–π, –Ω–µ –∫–∞–∫–æ–π-—Ç–æ –¥—Ä—É–≥–æ–π –∫–æ–º–ø–∞–Ω–∏–∏... - —ç—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –º–æ–π —Å–∫–ª–∞–¥, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —è –ø—Ä–∏–Ω–∏–º–∞—é –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–∑–æ–≤, –≤ —Ç–æ–º —á–∏—Å–ª–µ –∏ —Å *Poizon*.\n\n',
                {
                    parse_mode: 'Markdown',
                    disable_web_page_preview: true
                }
            )
            break

        case 'feedback':
            await bot.sendMessage(
                callback.message.chat.id,
                '[–ó–¥–µ—Å—å](https://www.instagram.com/s/aGlnaGxpZ2h0OjE3OTk3NTk1ODM3NTYzMDcy) –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–æ–∏ –æ—Ç–∑—ã–≤—ã:)',
                {
                    parse_mode: 'Markdown',
                    disable_web_page_preview: true
                }
            )
            break
    
        case 'price_calculator':
            const user_price_question = await bot.sendMessage(
                callback.message.chat.id,
                '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ *—é–∞–Ω—è—Ö ¬•*:\n\n(_–¶–µ–Ω–∞ —É–∫–∞–∑–∞–Ω–∞ —Å —É—á–µ—Ç–æ–º –¥–æ—Å—Ç–∞–∫–∏ –¥–æ –ú–æ—Å–∫–≤—ã –∏ –º–æ–µ–π –∫–æ–º–∏—Å—Å–∏–µ–π_)',
                {
                    parse_mode: 'Markdown',
                    reply_markup: {
                        force_reply: true
                    }
                }
            )
            bot.onReplyToMessage(callback.message.chat.id, user_price_question.message_id, async (message_name) => {
                const price = Number(message_name.text).toFixed(2)
                const current_currency = (((await converter.convert('CNY', 1, 'RUB')).amount + 1).toFixed(2))
                if (price === 'NaN') {
                    await bot.sendMessage(
                        callback.message.chat.id,
                        `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –≤ *—Ü–∏—Ñ—Ä–∞—Ö*`,
                        {
                            parse_mode: 'Markdown'
                        }
                    )
                } else {
                    const multiplier = current_currency
                    const tax = 1500
                    const percent = price * 0.15
                    await bot.sendMessage(
                        callback.message.chat.id,
                        `–í–∞—à–∞ —Ü–µ–Ω–∞ –±—É–¥–µ—Ç —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å: *${(price * multiplier) + tax + percent}*‚ÇΩ`,
                        {
                            parse_mode: 'Markdown'
                        }
                    )
                }
            })
            break
        
        case 'checkout':
            const photoGroup = [
                {
                    type: 'photo',
                    media: 'src/img/checkoutInstruction.jpg',
                    caption: '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è'
                },
                {
                    type: 'photo',
                    media: 'src/img/checkoutExampleFirst.jpg',
                    caption: '–ü—Ä–∏–º–µ—Ä #1'
                },
                {
                    type: 'photo',
                    media: 'src/img/checkoutExampleSecond.jpg',
                    caption: '–ü—Ä–∏–º–µ—Ä #2'
                },
            ]
            await bot.sendMediaGroup(
                callback.message.chat.id,
                photoGroup
            )
            const user_order = await bot.sendMessage(
                callback.message.chat.id,
                '–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å–æ–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑, –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å *–¥–≤–∞* —à–∞–≥–∞:\n\n*1*: –°–∫—Ä–∏–Ω—à–æ—Ç —Ç–æ–≤–∞—Ä–∞ ( –∫–æ—Ç–æ—Ä—ã–π –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç )\n*2*: –°–∫—Ä–∏–Ω—à–æ—Ç —Ä–∞–∑–º–µ—Ä–∞\n\n*–ü—Ä–∏–º–µ—Ä—ã* —Ñ–æ—Ç–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤—ã—à–µ',
                {
                    parse_mode: 'Markdown',
                    reply_markup: {
                        force_reply: true
                    }
                }
            )
            bot.onReplyToMessage(
                callback.message.chat.id,
                user_order.message_id,
                async (order) => {
                    await bot.sendMessage(
                        `${process.env.ADMIN_USERID}`,
                        `*–ù–æ–≤—ã–π –∑–∞–∫–∞–∑*\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @${order.from.username}\n –ò–º—è: ${order.from.first_name}`,
                        {
                            parse_mode: 'Markdown'
                        }
                    )
                    await bot.forwardMessage(
                        `${process.env.ADMIN_USERID}`,
                        callback.message.chat.id,
                        order.message_id
                    )
                    await bot.sendMessage(
                        callback.message.chat.id,
                        '*–ó–∞–∫–∞–∑* —É—Å–ø–µ—à–Ω–æ *—Å–æ–∑–¥–∞–Ω* ‚úÖ',
                        {
                            parse_mode: 'Markdown'
                        }
                    )
                }
            )
            break
    }
})

bot.on('polling_error', async (error) => {
    console.log(error)
})